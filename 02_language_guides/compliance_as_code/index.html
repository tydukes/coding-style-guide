
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Standards for automated compliance validation using InSpec, Open Policy Agent (OPA), and policy-as-code frameworks">
      
      
        <meta name="author" content="Tyler Dukes">
      
      
        <link rel="canonical" href="https://tydukes.github.io/coding-style-guide/02_language_guides/compliance_as_code/">
      
      
        <link rel="prev" href="../gitlab_ci/">
      
      
        <link rel="next" href="../yaml/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Compliance as Code Style Guide - The Dukes Engineering Style Guide</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#language-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="The Dukes Engineering Style Guide" class="md-header__button md-logo" aria-label="The Dukes Engineering Style Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Dukes Engineering Style Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Compliance as Code Style Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tydukes/coding-style-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    coding-style-guide
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../01_overview/getting_started/" class="md-tabs__link">
          
  
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../00_standards/heading_structure/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../comparison_matrix/" class="md-tabs__link">
          
  
  
  Language Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../03_metadata_schema/schema_reference/" class="md-tabs__link">
        
  
  
    
  
  Metadata Schema

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../04_templates/README_template/" class="md-tabs__link">
          
  
  
  Templates

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../05_examples/python_package_example/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../09_refactoring/" class="md-tabs__link">
          
  
  
  Refactoring

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../08_anti_patterns/" class="md-tabs__link">
          
  
  
  Anti-Patterns

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../10_migration_guides/from_pep8/" class="md-tabs__link">
          
  
  
  Migration Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../05_ci_cd/ai_validation_pipeline/" class="md-tabs__link">
          
  
  
  CI / CD

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../06_container/usage/" class="md-tabs__link">
        
  
  
    
  
  Container Usage

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../07_integration/integration_prompt/" class="md-tabs__link">
          
  
  
  Integration

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../changelog/" class="md-tabs__link">
        
  
  
    
  
  Changelog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Dukes Engineering Style Guide" class="md-nav__button md-logo" aria-label="The Dukes Engineering Style Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The Dukes Engineering Style Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tydukes/coding-style-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    coding-style-guide
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Overview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_overview/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_overview/principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principles
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_overview/governance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Governance
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_overview/structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structure
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_overview/decision_trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Decision Trees
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project Status
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Standards
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Standards
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00_standards/heading_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Heading Structure
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00_standards/code_block_language_tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Block Language Tags
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Language Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Language Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../comparison_matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comparison Matrix
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Infrastructure as Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Infrastructure as Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform & Terragrunt
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../terragrunt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terragrunt (live)
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hcl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HCL
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudformation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS CloudFormation
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bicep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azure Bicep
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cdk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS CDK
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pulumi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pulumi
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes & Helm
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitOps (ArgoCD & Flux)
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Configuration Management
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration Management
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Programming Languages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Programming Languages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../typescript/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScript
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bash
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../powershell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PowerShell
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SQL
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CI/CD & Automation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    CI/CD & Automation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jenkins_groovy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jenkins / Groovy
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../github_actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Actions
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gitlab_ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitLab CI/CD
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" checked>
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Compliance as Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Compliance as Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    InSpec, OPA & Sentinel
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    InSpec, OPA & Sentinel
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#language-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Language Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Language Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Characteristics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Supported Frameworks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Reference
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspec-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InSpec Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#profile-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Profile Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Profile Metadata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-naming-and-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Control Naming and Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-configuration-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Configuration Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#port-and-service-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Port and Service Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        File System Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Resources
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-resource-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS Resource Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#waivers-and-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Waivers and Exceptions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#open-policy-agent-opa-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Open Policy Agent (OPA) Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Open Policy Agent (OPA) Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policy-directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Policy Directory Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-naming-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package Naming Conventions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-admission-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Admission Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#container-image-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Container Image Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policy Enforcement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbac-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      
        RBAC Policy Enforcement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-terraform-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS Terraform Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-group-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Group Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-policy-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Policy Unit Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-sentinel-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Sentinel Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Sentinel Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policy-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Policy Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s3-encryption-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 Encryption Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-group-restriction-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Group Restriction Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-tagging-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource Tagging Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-size-limit-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Instance Size Limit Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#region-restriction-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Region Restriction Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-test-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Test Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cicd-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        CI/CD Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CI/CD Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#github-actions-inspec-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        GitHub Actions InSpec Workflow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-conftest-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Conftest Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-plan-with-opa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Plan with OPA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-admission-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Admission Controller
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compliance-framework-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Framework Mapping
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compliance Framework Mapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cis-benchmark-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        CIS Benchmark Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pci-dss-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        PCI-DSS Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hipaa-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        HIPAA Mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reporting-and-dashboards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reporting and Dashboards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reporting and Dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspec-json-reporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec JSON Reporter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-dashboard-yaml" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Dashboard YAML
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-metrics-exporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prometheus Metrics Exporter
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recommended Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspec-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ide-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      
        IDE Extensions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-commit-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pre-commit Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anti-patterns-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Anti-Patterns to Avoid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Anti-Patterns to Avoid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overly-permissive-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overly Permissive Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardcoded-values" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardcoded Values
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-error-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Missing Error Context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#untestable-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Untestable Policies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#official-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Official Documentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Frameworks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#community-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Community Resources
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-guides" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Guides
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Formats
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Formats
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../yaml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YAML
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../json/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JSON
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../toml_ini/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TOML & INI
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
        
          
          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Containerization
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Containerization
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dockerfile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dockerfile
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker_compose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Compose
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devcontainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dev Containers
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Build Tools
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Build Tools
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../makefile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Makefile
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../task_runners/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Task & Just
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >
        
          
          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diagram as Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diagram as Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../diagram_as_code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diagram as Code
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../03_metadata_schema/schema_reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metadata Schema
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Templates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Templates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/README_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    README Template
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/terraform_module_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform Module
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/python_package_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Package
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/gitignore_templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    .gitignore Templates
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/precommit_config_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pre-commit Config
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/github_actions_workflow_templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Actions Workflows
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/dockerfile_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dockerfile
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/docker_compose_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Compose
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/helm_chart_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Helm Chart
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/contract_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CONTRACT.md Template
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/testing_docs_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Documentation
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/ide_settings_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IDE Settings
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/operational_templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operational Templates
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/adr_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR Template
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/reusable_workflows_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reusable Workflows
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04_templates/code_generators_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Generators
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_examples/python_package_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Package
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_examples/terraform_module_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform Module
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_examples/ansible_role_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible Role
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_examples/typescript_library_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScript Library
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Refactoring
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Refactoring
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/python_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Examples
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/typescript_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScript Examples
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/terraform_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform Examples
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/ansible_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible Examples
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09_refactoring/bash_refactoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bash Examples
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Anti-Patterns
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Anti-Patterns
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../08_anti_patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common Anti-Patterns
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../08_anti_patterns/code_smell_catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Smell Catalog
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Migration Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migration Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10_migration_guides/from_pep8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From PEP 8
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10_migration_guides/from_google/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From Google Style Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10_migration_guides/from_airbnb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From Airbnb Style Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CI / CD
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    CI / CD
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/ai_validation_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Validation Pipeline
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/changelog_automation_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog Automation
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/github_actions_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Actions Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/dependency_update_policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dependency Update Policies
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/dependabot_auto_merge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dependabot Auto-Merge
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/gitlab_ci_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitLab CI Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/jenkins_pipeline_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jenkins Pipeline Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/precommit_hooks_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pre-commit Hooks Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/local_validation_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Validation Setup
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/ide_integration_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IDE Integration Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/security_scanning_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security Scanning Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/code_signing_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Signing Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/testing_strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Strategies
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/smoke_test_standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smoke Test Standards
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/performance_testing_standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance Testing
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/chaos_engineering_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chaos Engineering
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/seed_data_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Seed Data Management
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/environment_configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Environment Configuration
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/observability_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05_ci_cd/iac_testing_standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IaC Testing Standards
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../06_container/usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Container Usage
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07_integration/integration_prompt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration Guide
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07_integration/ai_code_review/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Code Review
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../07_integration/cli_tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Tool
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#language-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Language Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Language Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Characteristics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Supported Frameworks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Reference
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspec-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InSpec Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#profile-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Profile Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profile-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Profile Metadata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-naming-and-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Control Naming and Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-configuration-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Configuration Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#port-and-service-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Port and Service Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        File System Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Resources
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-resource-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS Resource Controls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#waivers-and-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Waivers and Exceptions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#open-policy-agent-opa-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Open Policy Agent (OPA) Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Open Policy Agent (OPA) Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policy-directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Policy Directory Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-naming-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package Naming Conventions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-admission-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Admission Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#container-image-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Container Image Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policy Enforcement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbac-policy-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      
        RBAC Policy Enforcement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-terraform-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS Terraform Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-group-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Group Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-policy-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Policy Unit Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-sentinel-standards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Sentinel Standards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terraform Sentinel Standards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policy-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Policy Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s3-encryption-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 Encryption Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-group-restriction-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Group Restriction Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-tagging-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource Tagging Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instance-size-limit-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Instance Size Limit Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#region-restriction-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Region Restriction Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-test-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Test Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cicd-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        CI/CD Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CI/CD Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#github-actions-inspec-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        GitHub Actions InSpec Workflow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-conftest-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Conftest Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-plan-with-opa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Plan with OPA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-admission-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Admission Controller
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compliance-framework-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Framework Mapping
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compliance Framework Mapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cis-benchmark-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        CIS Benchmark Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pci-dss-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        PCI-DSS Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hipaa-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        HIPAA Mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reporting-and-dashboards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reporting and Dashboards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reporting and Dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspec-json-reporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec JSON Reporter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-dashboard-yaml" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Dashboard YAML
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-metrics-exporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prometheus Metrics Exporter
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommended Tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recommended Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspec-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        InSpec Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sentinel-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sentinel Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ide-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      
        IDE Extensions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-commit-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pre-commit Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anti-patterns-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Anti-Patterns to Avoid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Anti-Patterns to Avoid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overly-permissive-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overly Permissive Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardcoded-values" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardcoded Values
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-error-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Missing Error Context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#untestable-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Untestable Policies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#official-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Official Documentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance Frameworks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#community-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        Community Resources
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-guides" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Guides
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>InSpec, OPA & Sentinel</h1>

<h2 id="language-overview">Language Overview<a class="headerlink" href="#language-overview" title="Permanent link">&para;</a></h2>
<p><strong>Compliance as Code</strong> enables automated validation of infrastructure against compliance requirements
and security policies. This guide covers InSpec (Ruby DSL), Open Policy Agent (Rego), and Terraform
Sentinel for policy enforcement.</p>
<h3 id="key-characteristics">Key Characteristics<a class="headerlink" href="#key-characteristics" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Paradigm</strong>: Declarative policy definition</li>
<li><strong>Languages</strong>: Ruby (InSpec), Rego (OPA), Sentinel (HashiCorp)</li>
<li><strong>Typing</strong>: Dynamic with strong validation constraints</li>
<li><strong>Primary Use Cases</strong>:</li>
<li>Infrastructure compliance validation</li>
<li>Kubernetes admission control</li>
<li>Terraform plan enforcement</li>
<li>Cloud security posture management</li>
</ul>
<h3 id="supported-frameworks">Supported Frameworks<a class="headerlink" href="#supported-frameworks" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Language</th>
<th>Primary Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>InSpec</td>
<td>Ruby DSL</td>
<td>Infrastructure compliance testing</td>
</tr>
<tr>
<td>Open Policy Agent</td>
<td>Rego</td>
<td>Kubernetes/API policy enforcement</td>
</tr>
<tr>
<td>Sentinel</td>
<td>HCL-like</td>
<td>Terraform Cloud policy enforcement</td>
</tr>
<tr>
<td>Conftest</td>
<td>Rego</td>
<td>Configuration file validation</td>
</tr>
<tr>
<td>Checkov</td>
<td>Python/YAML</td>
<td>IaC security scanning</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="quick-reference">Quick Reference<a class="headerlink" href="#quick-reference" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th><strong>Category</strong></th>
<th><strong>Convention</strong></th>
<th><strong>Example</strong></th>
<th><strong>Notes</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>InSpec</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Profile names</td>
<td><code>kebab-case</code></td>
<td><code>cis-linux-baseline</code></td>
<td>Descriptive, framework-based</td>
</tr>
<tr>
<td>Control IDs</td>
<td><code>framework-number</code></td>
<td><code>cis-1.1.1</code>, <code>pci-req-8.2</code></td>
<td>Traceable to standard</td>
</tr>
<tr>
<td>Resource names</td>
<td><code>snake_case</code></td>
<td><code>sshd_config</code>, <code>file_resource</code></td>
<td>Ruby convention</td>
</tr>
<tr>
<td><strong>OPA/Rego</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Package names</td>
<td><code>dot.separated</code></td>
<td><code>kubernetes.admission</code></td>
<td>Hierarchical namespacing</td>
</tr>
<tr>
<td>Rule names</td>
<td><code>snake_case</code></td>
<td><code>deny_root_user</code></td>
<td>Verb prefix for actions</td>
</tr>
<tr>
<td>Variable names</td>
<td><code>snake_case</code></td>
<td><code>container_image</code></td>
<td>Descriptive, lowercase</td>
</tr>
<tr>
<td><strong>Sentinel</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Policy names</td>
<td><code>kebab-case</code></td>
<td><code>require-s3-encryption</code></td>
<td>Action-oriented naming</td>
</tr>
<tr>
<td>Rule names</td>
<td><code>snake_case</code></td>
<td><code>main</code>, <code>s3_encrypted</code></td>
<td>HCL-like conventions</td>
</tr>
<tr>
<td>Import aliases</td>
<td><code>lowercase</code></td>
<td><code>tfplan</code>, <code>tfrun</code></td>
<td>Short, recognizable</td>
</tr>
<tr>
<td><strong>File Structure</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>InSpec profiles</td>
<td><code>profiles/{name}/</code></td>
<td><code>profiles/cis-linux/</code></td>
<td>Standard InSpec layout</td>
</tr>
<tr>
<td>OPA policies</td>
<td><code>policies/{domain}/</code></td>
<td><code>policies/kubernetes/</code></td>
<td>Domain-based organization</td>
</tr>
<tr>
<td>Sentinel policies</td>
<td><code>policies/{category}/</code></td>
<td><code>policies/cost/</code></td>
<td>Category-based grouping</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="inspec-standards">InSpec Standards<a class="headerlink" href="#inspec-standards" title="Permanent link">&para;</a></h2>
<h3 id="profile-structure">Profile Structure<a class="headerlink" href="#profile-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>profiles/
 cis-linux-baseline/
    inspec.yml           # Profile metadata
    controls/
       filesystem.rb    # Filesystem controls
       ssh.rb           # SSH controls
       audit.rb         # Audit controls
    libraries/
       custom_resource.rb
    files/
       expected_config.txt
    README.md
 pci-dss-baseline/
 hipaa-baseline/
</code></pre></div>
<h3 id="profile-metadata">Profile Metadata<a class="headerlink" href="#profile-metadata" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># inspec.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cis-linux-baseline</span>
<span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CIS Linux Benchmark</span>
<span class="nt">maintainer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Security Team</span>
<span class="nt">copyright</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Example Corp</span>
<span class="nt">copyright_email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security@example.com</span>
<span class="nt">license</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apache-2.0</span>
<span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InSpec profile for CIS Linux Level 1 Benchmark</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.1.0</span>
<span class="nt">inspec_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&gt;=</span><span class="nv"> </span><span class="s">5.0&quot;</span>

<span class="nt">supports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redhat</span>
<span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8.*</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
<span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">22.04</span>

<span class="nt">depends</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux-baseline</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/dev-sec/linux-baseline/archive/master.tar.gz</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&gt;=</span><span class="nv"> </span><span class="s">2.0&quot;</span>

<span class="nt">attributes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssh_allowed_ciphers</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">List of approved SSH ciphers</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aes256-gcm@openssh.com</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aes128-gcm@openssh.com</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aes256-ctr</span>
</code></pre></div>
<h3 id="control-naming-and-structure">Control Naming and Structure<a class="headerlink" href="#control-naming-and-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/ssh.rb</span>
<span class="c1"># @module ssh_controls</span>
<span class="c1"># @description SSH hardening controls per CIS Benchmark</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="c1"># CIS 5.2.1 - Ensure sshd_config permissions</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-5.2.1&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure permissions on /etc/ssh/sshd_config are configured&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;The sshd_config file needs to be protected from unauthorized changes.&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;rationale&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unauthorized modification could allow insecure configurations.&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;check&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Verify file permissions are 0600 or more restrictive.&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;fix&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Run: chmod 600 /etc/ssh/sshd_config&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_controls</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;5.1&#39;</span><span class="o">]</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;high&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">compliance</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;cis&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pci-dss-req-2.2&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="n">ref</span><span class="w"> </span><span class="s1">&#39;CIS Benchmark&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://www.cisecurity.org/benchmark/linux&#39;</span>
<span class="w">  </span><span class="n">ref</span><span class="w"> </span><span class="s1">&#39;NIST 800-53&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://nvd.nist.gov/800-53&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_file</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_owned_by</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_grouped_into</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="s1">&#39;0600&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 5.2.2 - Ensure SSH access is limited</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-5.2.2&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH access is limited&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Restrict SSH access to authorized users and groups only.&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;high&#39;</span>

<span class="w">  </span><span class="n">only_if</span><span class="p">(</span><span class="s1">&#39;SSH server is installed&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">package</span><span class="p">(</span><span class="s1">&#39;openssh-server&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">installed?</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;AllowUsers&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_nil</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;AllowGroups&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_nil</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;DenyUsers&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 5.2.4 - Ensure SSH Protocol is set to 2</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-5.2.4&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH Protocol is set to 2&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;SSH Protocol 1 has known vulnerabilities.&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Protocol&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 5.2.5 - Ensure SSH LogLevel is appropriate</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-5.2.5&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH LogLevel is appropriate&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;SSH LogLevel should be set to VERBOSE or INFO.&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;LogLevel&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_in</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;VERBOSE&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;INFO&#39;</span><span class="o">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="ssh-configuration-controls">SSH Configuration Controls<a class="headerlink" href="#ssh-configuration-controls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/ssh_hardening.rb</span>
<span class="c1"># Complete SSH hardening validation</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH root login is disabled&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;PermitRootLogin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;no&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH password authentication is disabled&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;PasswordAuthentication&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;no&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;PubkeyAuthentication&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;yes&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-03&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH idle timeout is configured&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;ClientAliveInterval&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;ClientAliveCountMax&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-04&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure only approved ciphers are used&#39;</span>

<span class="w">  </span><span class="n">approved_ciphers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attribute</span><span class="p">(</span><span class="s1">&#39;ssh_allowed_ciphers&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s1">&#39;aes256-gcm@openssh.com&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;aes128-gcm@openssh.com&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;aes256-ctr&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;aes192-ctr&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;aes128-ctr&#39;</span>
<span class="w">  </span><span class="o">]</span><span class="p">)</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Ciphers&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_nil</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">sshd_config</span><span class="o">.</span><span class="n">Ciphers</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">cipher</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Cipher </span><span class="si">#{</span><span class="n">cipher</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">expect</span><span class="p">(</span><span class="n">approved_ciphers</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="w"> </span><span class="kp">include</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-05&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH MaxAuthTries is set&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;MaxAuthTries&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;ssh-hardening-06&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH banner is configured&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Banner&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;/etc/issue.net&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/issue.net&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="sr">/Authorized users only/</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="port-and-service-validation">Port and Service Validation<a class="headerlink" href="#port-and-service-validation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/network.rb</span>
<span class="c1"># Network and port validation controls</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-ports-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure SSH is listening on port 22&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_listening</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;tcp&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;addresses&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;0.0.0.0&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-ports-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure unnecessary ports are closed&#39;</span>

<span class="w">  </span><span class="n">unnecessary_ports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">143</span><span class="o">]</span>

<span class="w">  </span><span class="n">unnecessary_ports</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="nb">p</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_listening</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-ports-03&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure web services use TLS&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="mi">443</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_listening</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># HTTP should redirect to HTTPS</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_listening</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-firewall-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure firewall is active&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;firewalld&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_running</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="file-system-controls">File System Controls<a class="headerlink" href="#file-system-controls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/filesystem.rb</span>
<span class="c1"># File system security controls</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-permissions-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure /etc/passwd permissions are secure&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="s1">&#39;0644&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-permissions-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure /etc/shadow permissions are secure&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/shadow&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="s1">&#39;0640&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_readable</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="s1">&#39;others&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-permissions-03&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure no world-writable files exist&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;find / -xdev -type f -perm -0002 2&gt;/dev/null&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_empty</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-permissions-04&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure no unowned files exist&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;find / -xdev -nouser 2&gt;/dev/null&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_empty</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-partitions-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure separate partitions for critical directories&#39;</span>

<span class="w">  </span><span class="n">critical_mounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/var&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/var/log&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/var/log/audit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/home&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="n">critical_mounts</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">mount_point</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">mount_point</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_mounted</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;fs-partitions-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure /tmp has noexec option&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_mounted</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;noexec&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;nosuid&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;nodev&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="custom-resources">Custom Resources<a class="headerlink" href="#custom-resources" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># libraries/aws_security_group_extended.rb</span>
<span class="c1"># Custom InSpec resource for enhanced AWS security group validation</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AwsSecurityGroupExtended</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Inspec</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="nb">name</span><span class="w"> </span><span class="s1">&#39;aws_security_group_extended&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;Extended AWS Security Group resource with compliance checks&#39;</span>

<span class="w">  </span><span class="n">example</span><span class="w"> </span><span class="o">&lt;&lt;~</span><span class="dl">EXAMPLE</span>
<span class="sh">    describe aws_security_group_extended(group_id: &#39;sg-12345678&#39;) do</span>
<span class="sh">      it { should_not have_unrestricted_ingress }</span>
<span class="sh">      it { should_not allow_ingress_from_anywhere_to_port(22) }</span>
<span class="sh">      its(&#39;open_ports&#39;) { should_not include 3389 }</span>
<span class="sh">    end</span>
<span class="dl">  EXAMPLE</span>

<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:group_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:vpc_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:ingress_rules</span><span class="p">,</span><span class="w"> </span><span class="ss">:egress_rules</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span>
<span class="w">    </span><span class="vi">@group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opts</span><span class="o">[</span><span class="ss">:group_id</span><span class="o">]</span>
<span class="w">    </span><span class="vi">@sg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_security_group</span>
<span class="w">    </span><span class="vi">@ingress_rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@sg</span><span class="o">&amp;.</span><span class="n">ip_permissions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="vi">@egress_rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@sg</span><span class="o">&amp;.</span><span class="n">ip_permissions_egress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="vi">@vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@sg</span><span class="o">&amp;.</span><span class="n">vpc_id</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">exists?</span>
<span class="w">    </span><span class="o">!</span><span class="vi">@sg</span><span class="o">.</span><span class="n">nil?</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">has_unrestricted_ingress?</span>
<span class="w">    </span><span class="vi">@ingress_rules</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">rule</span><span class="o">|</span>
<span class="w">      </span><span class="n">rule</span><span class="o">.</span><span class="n">ip_ranges</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">cidr_ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">rule</span><span class="o">.</span><span class="n">ipv_6_ranges</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">cidr_ipv_6_block</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;::/0&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">allow_ingress_from_anywhere_to_port?</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@ingress_rules</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">rule</span><span class="o">|</span>
<span class="w">      </span><span class="n">matches_port?</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">ip_ranges</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">cidr_ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="n">rule</span><span class="o">.</span><span class="n">ipv_6_ranges</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">cidr_ipv_6_block</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;::/0&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">open_ports</span>
<span class="w">    </span><span class="n">ports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="vi">@ingress_rules</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">rule</span><span class="o">|</span>
<span class="w">      </span><span class="k">next</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">rule</span><span class="o">.</span><span class="n">ip_ranges</span><span class="o">.</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">cidr_ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">rule</span><span class="o">.</span><span class="n">from_port</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rule</span><span class="o">.</span><span class="n">to_port</span>
<span class="w">        </span><span class="n">ports</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rule</span><span class="o">.</span><span class="n">from_port</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">ports</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">from_port</span><span class="o">..</span><span class="n">rule</span><span class="o">.</span><span class="n">to_port</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">ports</span><span class="o">.</span><span class="n">uniq</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="kp">private</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">fetch_security_group</span>
<span class="w">    </span><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;aws-sdk-ec2&#39;</span>
<span class="w">    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Aws</span><span class="o">::</span><span class="no">EC2</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span>
<span class="w">    </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span><span class="ss">group_ids</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="vi">@group_id</span><span class="o">]</span><span class="p">)</span>
<span class="w">    </span><span class="n">response</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">first</span>
<span class="w">  </span><span class="k">rescue</span><span class="w"> </span><span class="no">Aws</span><span class="o">::</span><span class="no">EC2</span><span class="o">::</span><span class="no">Errors</span><span class="o">::</span><span class="no">InvalidGroupNotFound</span>
<span class="w">    </span><span class="kp">nil</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">matches_port?</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)</span>
<span class="w">    </span><span class="n">rule</span><span class="o">.</span><span class="n">from_port</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rule</span><span class="o">.</span><span class="n">to_port</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">port</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="aws-resource-controls">AWS Resource Controls<a class="headerlink" href="#aws-resource-controls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/aws_security.rb</span>
<span class="c1"># AWS security compliance controls</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-sg-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure no security groups allow unrestricted SSH access&#39;</span>

<span class="w">  </span><span class="n">aws_security_groups</span><span class="o">.</span><span class="n">group_ids</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">sg_id</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_security_group</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span><span class="w"> </span><span class="n">sg_id</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">allow_in</span><span class="p">(</span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="ss">ipv4_range</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-sg-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure no security groups allow unrestricted RDP access&#39;</span>

<span class="w">  </span><span class="n">aws_security_groups</span><span class="o">.</span><span class="n">group_ids</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">sg_id</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_security_group</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span><span class="w"> </span><span class="n">sg_id</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">allow_in</span><span class="p">(</span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">3389</span><span class="p">,</span><span class="w"> </span><span class="ss">ipv4_range</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-s3-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure S3 buckets have encryption enabled&#39;</span>

<span class="w">  </span><span class="n">aws_s3_buckets</span><span class="o">.</span><span class="n">bucket_names</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">bucket</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_s3_bucket</span><span class="p">(</span><span class="ss">bucket_name</span><span class="p">:</span><span class="w"> </span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_default_encryption_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-s3-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure S3 buckets block public access&#39;</span>

<span class="w">  </span><span class="n">aws_s3_buckets</span><span class="o">.</span><span class="n">bucket_names</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">bucket</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_s3_bucket</span><span class="p">(</span><span class="ss">bucket_name</span><span class="p">:</span><span class="w"> </span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_public</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;public_access_block.block_public_acls&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;public_access_block.block_public_policy&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-s3-03&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure S3 buckets have versioning enabled&#39;</span>

<span class="w">  </span><span class="n">aws_s3_buckets</span><span class="o">.</span><span class="n">bucket_names</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">bucket</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_s3_bucket</span><span class="p">(</span><span class="ss">bucket_name</span><span class="p">:</span><span class="w"> </span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_versioning_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-s3-04&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure S3 buckets have access logging enabled&#39;</span>

<span class="w">  </span><span class="n">aws_s3_buckets</span><span class="o">.</span><span class="n">bucket_names</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">bucket</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_s3_bucket</span><span class="p">(</span><span class="ss">bucket_name</span><span class="p">:</span><span class="w"> </span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_access_logging_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-iam-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires minimum length&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;minimum_password_length&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-iam-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy prevents password reuse&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;password_reuse_prevention&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-iam-03&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure MFA is enabled for root account&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_root_user</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_mfa_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-rds-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure RDS instances have encryption enabled&#39;</span>

<span class="w">  </span><span class="n">aws_rds_instances</span><span class="o">.</span><span class="n">db_instance_identifiers</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">db</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_rds_instance</span><span class="p">(</span><span class="ss">db_instance_identifier</span><span class="p">:</span><span class="w"> </span><span class="n">db</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_encrypted_storage</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;aws-rds-02&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure RDS instances are not publicly accessible&#39;</span>

<span class="w">  </span><span class="n">aws_rds_instances</span><span class="o">.</span><span class="n">db_instance_identifiers</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">db</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_rds_instance</span><span class="p">(</span><span class="ss">db_instance_identifier</span><span class="p">:</span><span class="w"> </span><span class="n">db</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_publicly_accessible</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="waivers-and-exceptions">Waivers and Exceptions<a class="headerlink" href="#waivers-and-exceptions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># waivers.yml</span>
<span class="c1"># Compliance waivers with documented justifications</span>

<span class="nt">cis-5.2.1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">expiration_date</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2025-06-30</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">justification</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Legacy</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">pending</span><span class="nv"> </span><span class="s">migration</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">ticket</span><span class="nv"> </span><span class="s">INFRA-1234&quot;</span>
<span class="w">  </span><span class="nt">approver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-team@example.com</span>
<span class="w">  </span><span class="nt">risk_acceptance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high</span>

<span class="nt">cis-5.2.2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">skipped_due_to</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Control</span><span class="nv"> </span><span class="s">handled</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">external</span><span class="nv"> </span><span class="s">SSO</span><span class="nv"> </span><span class="s">provider&quot;</span>
<span class="w">  </span><span class="nt">alternative_control</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;IDP-SSO-01&quot;</span>
<span class="w">  </span><span class="nt">approver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-team@example.com</span>

<span class="nt">aws-sg-01</span><span class="p">:</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">justification</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bastion</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">requires</span><span class="nv"> </span><span class="s">SSH</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">VPN</span><span class="nv"> </span><span class="s">range&quot;</span>
<span class="w">  </span><span class="nt">compensating_control</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;VPN</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">logged</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">monitored&quot;</span>
<span class="w">  </span><span class="nt">expiration_date</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2025-12-31</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># controls/with_waivers.rb</span>
<span class="c1"># Controls that handle waiver scenarios</span>

<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-5.2.1-waiverable&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure sshd_config permissions (with waiver support)&#39;</span>

<span class="w">  </span><span class="n">only_if</span><span class="p">(</span><span class="s1">&#39;Control not waived&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="o">!</span><span class="n">waiver_active?</span><span class="p">(</span><span class="s1">&#39;cis-5.2.1&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="s1">&#39;0600&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span><span class="w"> </span><span class="nf">waiver_active?</span><span class="p">(</span><span class="n">control_id</span><span class="p">)</span>
<span class="w">  </span><span class="n">waiver_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/etc/inspec/waivers.yml&#39;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">waiver_file</span><span class="p">)</span>

<span class="w">  </span><span class="n">waivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">waiver_file</span><span class="p">)</span>
<span class="w">  </span><span class="n">waiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waivers</span><span class="o">[</span><span class="n">control_id</span><span class="o">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="n">waiver</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">waiver</span><span class="o">[</span><span class="s1">&#39;expiration_date&#39;</span><span class="o">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">waiver</span><span class="o">[</span><span class="s1">&#39;expiration_date&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="no">Date</span><span class="o">.</span><span class="n">today</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">waiver</span><span class="o">[</span><span class="s1">&#39;run&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre></div>
<hr />
<h2 id="open-policy-agent-opa-standards">Open Policy Agent (OPA) Standards<a class="headerlink" href="#open-policy-agent-opa-standards" title="Permanent link">&para;</a></h2>
<h3 id="policy-directory-structure">Policy Directory Structure<a class="headerlink" href="#policy-directory-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>policies/
 kubernetes/
    admission/
       pod_security.rego
       network_policy.rego
       resource_limits.rego
    rbac/
       role_restrictions.rego
    data/
        approved_registries.json
 terraform/
    aws/
       s3_encryption.rego
       security_groups.rego
       iam_policies.rego
    gcp/
        storage_encryption.rego
 cicd/
    pipeline_security.rego
 lib/
     helpers.rego
</code></pre></div>
<h3 id="package-naming-conventions">Package Naming Conventions<a class="headerlink" href="#package-naming-conventions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/admission/pod_security.rego</span>

<span class="c1"># Good - hierarchical package naming</span>
<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">pod_security</span>

<span class="c1"># Bad - flat naming without hierarchy</span>
<span class="c1"># package pod_security</span>

<span class="c1"># Good - domain-specific package</span>
<span class="k">package</span><span class="w"> </span><span class="n">aws</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">encryption</span>

<span class="c1"># Good - shared library package</span>
<span class="k">package</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">helpers</span>
</code></pre></div>
<h3 id="kubernetes-admission-policies">Kubernetes Admission Policies<a class="headerlink" href="#kubernetes-admission-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/admission/pod_security.rego</span>
<span class="c1"># @module pod_security</span>
<span class="c1"># @description Kubernetes pod security admission policies</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">pod_security</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Deny pods running as root</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">securityContext</span><span class="p">.</span><span class="n">runAsNonRoot</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container &#39;%s&#39; must not run as root. Set securityContext.runAsNonRoot=true&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny privileged containers</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="n">container</span><span class="p">.</span><span class="n">securityContext</span><span class="p">.</span><span class="n">privileged</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container &#39;%s&#39; must not be privileged&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny containers without resource limits</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">memory</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container &#39;%s&#39; must have memory limits defined&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">cpu</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container &#39;%s&#39; must have CPU limits defined&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny hostNetwork usage</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">hostNetwork</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Pods must not use hostNetwork&quot;</span>
<span class="p">}</span>

<span class="c1"># Deny hostPID usage</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">hostPID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Pods must not use hostPID&quot;</span>
<span class="p">}</span>

<span class="c1"># Deny hostIPC usage</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">hostIPC</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">true</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Pods must not use hostIPC&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="container-image-policies">Container Image Policies<a class="headerlink" href="#container-image-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/admission/container_images.rego</span>
<span class="c1"># @module container_images</span>
<span class="c1"># @description Container image validation policies</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">container_images</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="k">import</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">approved_registries</span>

<span class="c1"># Default approved registries if data not provided</span>
<span class="n">default_approved_registries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;gcr.io/company-project&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;docker.io/company&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;ghcr.io/company&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;123456789.dkr.ecr.us-east-1.amazonaws.com&quot;</span>
<span class="p">]</span>

<span class="c1"># Get registries from data or use defaults</span>
<span class="n">registries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">object</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;approved_registries&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">default_approved_registries</span><span class="p">)</span>

<span class="c1"># Deny images from unapproved registries</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">image</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">image_from_approved_registry</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container image &#39;%s&#39; is not from an approved registry. Approved: %v&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">registries</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny images without explicit tags</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">image</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="k">contains</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;@sha256:&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">has_version_tag</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container image &#39;%s&#39; must use explicit version tag or digest, not &#39;latest&#39;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny images with &#39;latest&#39; tag</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">image</span>
<span class="w">    </span><span class="n">endswith</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;:latest&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container image &#39;%s&#39; must not use &#39;latest&#39; tag&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Helper: check if image is from approved registry</span>
<span class="n">image_from_approved_registry</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">registries</span>
<span class="w">    </span><span class="n">startswith</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Helper: check if image has version tag</span>
<span class="n">has_version_tag</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">parts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span><span class="n">tag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">parts</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
<span class="w">    </span><span class="n">tag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;latest&quot;</span>
<span class="w">    </span><span class="n">re_match</span><span class="p">(</span><span class="sb">`^v?\d+\.\d+`</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="network-policy-enforcement">Network Policy Enforcement<a class="headerlink" href="#network-policy-enforcement" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/admission/network_policy.rego</span>
<span class="c1"># @module network_policy</span>
<span class="c1"># @description Network policy enforcement for Kubernetes</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">network_policy</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Namespaces that require network policies</span>
<span class="n">protected_namespaces</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;production&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;staging&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;pci-workloads&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;hipaa-workloads&quot;</span>
<span class="p">]</span>

<span class="c1"># Deny deployments in protected namespaces without network policy</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Deployment&quot;</span>
<span class="w">    </span><span class="n">namespace</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">namespace</span>
<span class="w">    </span><span class="n">namespace</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">protected_namespaces</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">has_network_policy</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Deployment &#39;%s&#39; in namespace &#39;%s&#39; requires a NetworkPolicy&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Check for existing network policy</span>
<span class="n">has_network_policy</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="w"> </span><span class="n">app_name</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># This would query existing network policies</span>
<span class="w">    </span><span class="c1"># In practice, use data.kubernetes.networkpolicies</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">networkpolicies</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>
<span class="w">    </span><span class="n">policy</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">podSelector</span><span class="p">.</span><span class="n">matchLabels</span><span class="p">.</span><span class="n">app</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">app_name</span>
<span class="p">}</span>

<span class="c1"># Deny network policies with allow-all ingress</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">ingress</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy must define explicit ingress rules, not allow-all&quot;</span>
<span class="p">}</span>

<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">ingress</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy ingress rules must not be empty (allow-all)&quot;</span>
<span class="p">}</span>

<span class="c1"># Warn on overly permissive egress</span>
<span class="n">warn</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">egress</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;NetworkPolicy should define explicit egress rules&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="rbac-policy-enforcement">RBAC Policy Enforcement<a class="headerlink" href="#rbac-policy-enforcement" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/rbac/role_restrictions.rego</span>
<span class="c1"># @module role_restrictions</span>
<span class="c1"># @description RBAC policy restrictions for Kubernetes</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">restrictions</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Dangerous permissions that require review</span>
<span class="n">dangerous_permissions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;secrets&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]},</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]},</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;pods/exec&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;create&quot;</span><span class="p">]},</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;clusterroles&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]},</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;verbs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;escalate&quot;</span><span class="p">]}</span>
<span class="p">]</span>

<span class="c1"># Deny ClusterRoleBindings to cluster-admin</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;ClusterRoleBinding&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">roleRef</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;cluster-admin&quot;</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;ClusterRoleBinding to cluster-admin is prohibited&quot;</span>
<span class="p">}</span>

<span class="c1"># Deny creation of overly permissive ClusterRoles</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;ClusterRole&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">rules</span>
<span class="w">    </span><span class="n">is_dangerous_permission</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;ClusterRole &#39;%s&#39; contains dangerous permissions: resources=%v, verbs=%v&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">resources</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">verbs</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny wildcards in production namespaces</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Role&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">namespace</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">rules</span>
<span class="w">    </span><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">verbs</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Wildcard verbs are not allowed in production namespace&quot;</span>
<span class="p">}</span>

<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Role&quot;</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">namespace</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">rules</span>
<span class="w">    </span><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">resources</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Wildcard resources are not allowed in production namespace&quot;</span>
<span class="p">}</span>

<span class="c1"># Helper function to check dangerous permissions</span>
<span class="n">is_dangerous_permission</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dangerous_permissions</span>
<span class="w">    </span><span class="n">resources_match</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">resources</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">.</span><span class="n">resources</span><span class="p">)</span>
<span class="w">    </span><span class="n">verbs_match</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">verbs</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">.</span><span class="n">verbs</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">resources_match</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">dangerous</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dangerous</span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">actual</span>
<span class="p">}</span>

<span class="n">resources_match</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">dangerous</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">actual</span>
<span class="p">}</span>

<span class="n">verbs_match</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">dangerous</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dangerous</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">actual</span>
<span class="p">}</span>

<span class="n">verbs_match</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">dangerous</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">actual</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="aws-terraform-policy">AWS Terraform Policy<a class="headerlink" href="#aws-terraform-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/terraform/aws/s3_encryption.rego</span>
<span class="c1"># @module s3_encryption</span>
<span class="c1"># @description S3 bucket encryption enforcement for Terraform</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">terraform</span><span class="p">.</span><span class="n">aws</span><span class="p">.</span><span class="n">s3</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Deny S3 buckets without encryption</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket&quot;</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">server_side_encryption_configuration</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;S3 bucket &#39;%s&#39; must have server-side encryption enabled&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny S3 buckets without versioning</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_versioning&quot;</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">versioning_configuration</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;S3 bucket versioning &#39;%s&#39; must be enabled&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny public S3 buckets</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_public_access_block&quot;</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">block_public_acls</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;S3 bucket &#39;%s&#39; must block public ACLs&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_public_access_block&quot;</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">block_public_policy</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;S3 bucket &#39;%s&#39; must block public policy&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Require S3 buckets have logging enabled</span>
<span class="n">warn</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">has_logging_configuration</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;S3 bucket &#39;%s&#39; should have access logging enabled&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="n">has_logging_configuration</span><span class="p">(</span><span class="n">bucket_address</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_logging&quot;</span>
<span class="w">    </span><span class="k">contains</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">bucket_address</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="security-group-policy">Security Group Policy<a class="headerlink" href="#security-group-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/terraform/aws/security_groups.rego</span>
<span class="c1"># @module security_groups</span>
<span class="c1"># @description Security group policy enforcement for Terraform</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">terraform</span><span class="p">.</span><span class="n">aws</span><span class="p">.</span><span class="n">security_groups</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Restricted ports that should never be open to the internet</span>
<span class="n">restricted_ports</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="m">22</span><span class="p">,</span><span class="w"> </span><span class="m">3389</span><span class="p">,</span><span class="w"> </span><span class="m">3306</span><span class="p">,</span><span class="w"> </span><span class="m">5432</span><span class="p">,</span><span class="w"> </span><span class="m">27017</span><span class="p">,</span><span class="w"> </span><span class="m">6379</span><span class="p">,</span><span class="w"> </span><span class="m">11211</span><span class="p">]</span>

<span class="c1"># Deny security groups with unrestricted ingress on restricted ports</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_security_group_rule&quot;</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;ingress&quot;</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">from_port</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">restricted_ports</span>
<span class="w">    </span><span class="n">is_unrestricted_cidr</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">cidr_blocks</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Security group rule &#39;%s&#39; allows unrestricted access to port %d&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny security groups with 0.0.0.0/0 on any port range</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_security_group&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">ingress</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">ingress</span>
<span class="w">    </span><span class="n">is_unrestricted_cidr</span><span class="p">(</span><span class="n">ingress</span><span class="p">.</span><span class="n">cidr_blocks</span><span class="p">)</span>
<span class="w">    </span><span class="n">ingress</span><span class="p">.</span><span class="n">from_port</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ingress</span><span class="p">.</span><span class="n">to_port</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Security group &#39;%s&#39; allows unrestricted access to port range %d-%d&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">ingress</span><span class="p">.</span><span class="n">from_port</span><span class="p">,</span><span class="w"> </span><span class="n">ingress</span><span class="p">.</span><span class="n">to_port</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Deny security groups without descriptions</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_security_group&quot;</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">object</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;description&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Security group &#39;%s&#39; must have a description&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Warn on overly broad egress rules</span>
<span class="n">warn</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">resource_changes</span>
<span class="w">    </span><span class="n">resource</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;aws_security_group&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">egress</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="n">change</span><span class="p">.</span><span class="n">after</span><span class="p">.</span><span class="n">egress</span>
<span class="w">    </span><span class="n">is_unrestricted_cidr</span><span class="p">(</span><span class="n">egress</span><span class="p">.</span><span class="n">cidr_blocks</span><span class="p">)</span>
<span class="w">    </span><span class="n">egress</span><span class="p">.</span><span class="n">from_port</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="n">egress</span><span class="p">.</span><span class="n">to_port</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">65535</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Security group &#39;%s&#39; has overly broad egress rules&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">resource</span><span class="p">.</span><span class="n">address</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Helper to check for unrestricted CIDR</span>
<span class="n">is_unrestricted_cidr</span><span class="p">(</span><span class="n">cidrs</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cidrs</span>
<span class="p">}</span>

<span class="n">is_unrestricted_cidr</span><span class="p">(</span><span class="n">cidrs</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;::/0&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">cidrs</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="opa-policy-unit-tests">OPA Policy Unit Tests<a class="headerlink" href="#opa-policy-unit-tests" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># policies/kubernetes/admission/pod_security_test.rego</span>
<span class="c1"># @module pod_security_test</span>
<span class="c1"># @description Unit tests for pod security policies</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">pod_security_test</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="k">import</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span><span class="p">.</span><span class="n">pod_security</span>

<span class="c1"># Test: should deny pod running as root</span>
<span class="n">test_deny_root_container</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">false</span><span class="p">}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="c1"># Test: should allow pod with runAsNonRoot=true</span>
<span class="n">test_allow_non_root_container</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="c1"># Test: should deny privileged container</span>
<span class="n">test_deny_privileged_container</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">&quot;privileged&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="c1"># Test: should deny container without memory limits</span>
<span class="n">test_deny_missing_memory_limits</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">},</span>
<span class="w">                        </span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100m&quot;</span><span class="p">}}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="c1"># Test: should allow properly configured container</span>
<span class="n">test_allow_compliant_container</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">&quot;privileged&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="w">                        </span><span class="p">},</span>
<span class="w">                        </span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;limits&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100m&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="s2">&quot;memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;128Mi&quot;</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>

<span class="c1"># Test: should deny hostNetwork</span>
<span class="n">test_deny_host_network</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pod_security</span><span class="p">.</span><span class="n">deny</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;hostNetwork&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;securityContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;runAsNonRoot&quot;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">},</span>
<span class="w">                        </span><span class="s2">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;limits&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;128Mi&quot;</span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="terraform-sentinel-standards">Terraform Sentinel Standards<a class="headerlink" href="#terraform-sentinel-standards" title="Permanent link">&para;</a></h2>
<h3 id="policy-structure">Policy Structure<a class="headerlink" href="#policy-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>policies/
 sentinel.hcl           # Policy configuration
 common/
    tfplan-functions/
        tfplan-functions.sentinel
 aws/
    require-s3-encryption.sentinel
    restrict-security-groups.sentinel
    require-tags.sentinel
 cost/
    limit-instance-size.sentinel
    restrict-regions.sentinel
 test/
     require-s3-encryption/
        pass.hcl
        fail.hcl
        mock-tfplan.sentinel
     restrict-security-groups/
         pass.hcl
         fail.hcl
</code></pre></div>
<h3 id="sentinel-configuration">Sentinel Configuration<a class="headerlink" href="#sentinel-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># sentinel.hcl</span>
<span class="c1"># Sentinel policy configuration</span>

<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;require-s3-encryption&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./aws/require-s3-encryption.sentinel&quot;</span>
<span class="w">  </span><span class="na">enforcement_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hard-mandatory&quot;</span>
<span class="p">}</span>

<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;restrict-security-groups&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./aws/restrict-security-groups.sentinel&quot;</span>
<span class="w">  </span><span class="na">enforcement_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hard-mandatory&quot;</span>
<span class="p">}</span>

<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;require-tags&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./aws/require-tags.sentinel&quot;</span>
<span class="w">  </span><span class="na">enforcement_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;soft-mandatory&quot;</span>
<span class="p">}</span>

<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;limit-instance-size&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./cost/limit-instance-size.sentinel&quot;</span>
<span class="w">  </span><span class="na">enforcement_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;advisory&quot;</span>
<span class="p">}</span>

<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;restrict-regions&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./cost/restrict-regions.sentinel&quot;</span>
<span class="w">  </span><span class="na">enforcement_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;soft-mandatory&quot;</span>
<span class="p">}</span>

<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;tfplan-functions&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./common/tfplan-functions/tfplan-functions.sentinel&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="s3-encryption-policy">S3 Encryption Policy<a class="headerlink" href="#s3-encryption-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># aws/require-s3-encryption.sentinel</span>
<span class="c1"># @module require-s3-encryption</span>
<span class="c1"># @description Ensures all S3 buckets have encryption enabled</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">tfplan</span>

<span class="c1"># Get all S3 bucket resources</span>
<span class="na">s3_buckets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Get all S3 bucket encryption configurations</span>
<span class="na">s3_encryption_configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_server_side_encryption_configuration&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Check if bucket has encryption configuration</span>
<span class="na">bucket_has_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">bucket_address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">any</span><span class="w"> </span><span class="err">s</span><span class="m">3</span><span class="err">_encryption_configs</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">config</span><span class="w"> </span><span class="p">{</span>
<span class="c1">        # Extract bucket name from address</span>
<span class="w">        </span><span class="nv">config.change.after.bucket</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="kt">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Main rule - all S3 buckets must have encryption</span>
<span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">s</span><span class="m">3</span><span class="err">_buckets</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">bucket_has_encryption</span><span class="p">(</span><span class="nv">bucket.address</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Output message for failures</span>
<span class="na">print_violations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">s</span><span class="m">3</span><span class="err">_buckets</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">address</span><span class="p">,</span><span class="w"> </span><span class="nb">bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">bucket_has_encryption</span><span class="p">(</span><span class="err">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">print</span><span class="p">(</span><span class="s2">&quot;S3 bucket&quot;, address, &quot;must have encryption enabled&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Execute print on failure</span>
<span class="na">validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">rule</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="nb">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">print_violations</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="security-group-restriction-policy">Security Group Restriction Policy<a class="headerlink" href="#security-group-restriction-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># aws/restrict-security-groups.sentinel</span>
<span class="c1"># @module restrict-security-groups</span>
<span class="c1"># @description Prevents unrestricted ingress on sensitive ports</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">tfplan</span>
<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan-functions&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">plan</span>

<span class="c1"># Restricted ports that should never be open to the world</span>
<span class="na">restricted_ports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="m">22</span><span class="p">,</span><span class="w"> </span><span class="m">3389</span><span class="p">,</span><span class="w"> </span><span class="m">3306</span><span class="p">,</span><span class="w"> </span><span class="m">5432</span><span class="p">,</span><span class="w"> </span><span class="m">27017</span><span class="p">,</span><span class="w"> </span><span class="m">6379</span><span class="p">]</span>

<span class="c1"># Get all security group rules</span>
<span class="na">sg_rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;aws_security_group_rule&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="nv">rc.change.after.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;ingress&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Get all security groups with inline rules</span>
<span class="na">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Check if CIDR is unrestricted</span>
<span class="na">is_unrestricted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">cidr_blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">cidr_blocks</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="nb">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">cidr_blocks</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;0.0.0.0/0&quot; or cidr_blocks contains &quot;::/0&quot;</span>
<span class="p">}</span>

<span class="c1"># Check if port is in restricted list</span>
<span class="na">is_restricted_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">from_port</span><span class="p">,</span><span class="w"> </span><span class="err">to_port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">restricted_ports</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="nb">port</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">from_port</span><span class="w"> </span><span class="err">&lt;</span><span class="p">=</span><span class="w"> </span><span class="err">port</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">to_port</span><span class="w"> </span><span class="err">&gt;</span><span class="p">=</span><span class="w"> </span><span class="nb">port</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="p">}</span>

<span class="c1"># Validate security group rules</span>
<span class="na">valid_sg_rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">sg_rules</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">not</span><span class="w"> </span><span class="p">(</span><span class="err">is_unrestricted</span><span class="p">(</span><span class="nv">rule.change.after.cidr_blocks</span><span class="p">)</span><span class="w"> </span><span class="err">and</span>
<span class="w">             </span><span class="err">is_restricted_port</span><span class="p">(</span><span class="nv">rule.change.after.from_port</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.change.after.to_port</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Validate inline security group ingress rules</span>
<span class="na">valid_sg_inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">security_groups</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">sg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">all</span><span class="w"> </span><span class="nv">sg.change.after.ingress</span><span class="w"> </span><span class="err">else</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="nb">ingress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">not</span><span class="w"> </span><span class="p">(</span><span class="err">is_unrestricted</span><span class="p">(</span><span class="nv">ingress.cidr_blocks</span><span class="p">)</span><span class="w"> </span><span class="err">and</span>
<span class="w">                 </span><span class="err">is_restricted_port</span><span class="p">(</span><span class="nv">ingress.from_port</span><span class="p">,</span><span class="w"> </span><span class="nv">ingress.to_port</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Combined main rule</span>
<span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">valid_sg_rules</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">valid_sg_inline</span>
<span class="p">}</span>

<span class="c1"># Print violations for debugging</span>
<span class="na">print_violations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">sg_rules</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">address</span><span class="p">,</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">is_unrestricted</span><span class="p">(</span><span class="nv">rule.change.after.cidr_blocks</span><span class="p">)</span><span class="w"> </span><span class="err">and</span>
<span class="w">           </span><span class="err">is_restricted_port</span><span class="p">(</span><span class="nv">rule.change.after.from_port</span><span class="p">,</span><span class="w"> </span><span class="nv">rule.change.after.to_port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">print</span><span class="p">(</span><span class="s2">&quot;Security group rule&quot;, address, &quot;has unrestricted access to port&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="nv">rule.change.after.from_port</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="resource-tagging-policy">Resource Tagging Policy<a class="headerlink" href="#resource-tagging-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># aws/require-tags.sentinel</span>
<span class="c1"># @module require-tags</span>
<span class="c1"># @description Ensures all resources have required tags</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">tfplan</span>

<span class="c1"># Required tags for all resources</span>
<span class="na">required_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Environment&quot;, &quot;Owner&quot;, &quot;CostCenter&quot;, &quot;Project&quot;</span><span class="p">]</span>

<span class="c1"># Resource types that support tags</span>
<span class="na">taggable_resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;aws_instance&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_s3_bucket&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_rds_instance&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_vpc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_subnet&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_security_group&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_lambda_function&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_dynamodb_table&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_sqs_queue&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_sns_topic&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_ecs_cluster&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_ecs_service&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_eks_cluster&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;aws_elasticache_cluster&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Get all taggable resources being created or updated</span>
<span class="na">resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">taggable_resources</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Check if resource has all required tags</span>
<span class="na">has_required_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">resource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">resource.change.after.tags</span><span class="w"> </span><span class="nb">else</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">tags</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="nb">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">required_tags</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="nb">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">tag</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="err">tags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">tags</span><span class="p">[</span><span class="nb">tag</span><span class="p">]</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="err">tags</span><span class="p">[</span><span class="nb">tag</span><span class="p">]</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="nb">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Main rule</span>
<span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">resource</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">has_required_tags</span><span class="p">(</span><span class="err">resource</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print missing tags for debugging</span>
<span class="na">print_missing_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">address</span><span class="p">,</span><span class="w"> </span><span class="nb">resource</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">resource.change.after.tags</span><span class="w"> </span><span class="nb">else</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="err">for</span><span class="w"> </span><span class="err">required_tags</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="nb">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">if</span><span class="w"> </span><span class="err">tag</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="err">tags</span><span class="p">)</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="err">tags</span><span class="p">[</span><span class="nb">tag</span><span class="p">]</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">print</span><span class="p">(</span><span class="s2">&quot;Resource&quot;, address, &quot;is missing required tag:&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">tag</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># Execute on failure</span>
<span class="na">validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">rule</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="nb">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">print_missing_tags</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="instance-size-limit-policy">Instance Size Limit Policy<a class="headerlink" href="#instance-size-limit-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># cost/limit-instance-size.sentinel</span>
<span class="c1"># @module limit-instance-size</span>
<span class="c1"># @description Limits EC2 instance sizes for cost control</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">tfplan</span>

<span class="c1"># Allowed instance types by environment</span>
<span class="nb">allowed_instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;development&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;t3.micro&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.small&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.medium&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="s2">&quot;staging&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;t3.micro&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.small&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.medium&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.large&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;m5.large&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="s2">&quot;production&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;t3.small&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.medium&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.large&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;t3.xlarge&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;m5.large&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;m5.xlarge&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;m5.2xlarge&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;r5.large&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;r5.xlarge&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Prohibited instance types (very expensive)</span>
<span class="na">prohibited_instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;p3.16xlarge&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;p4d.24xlarge&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;x1e.32xlarge&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;x2idn.32xlarge&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;u-6tb1.metal&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;u-12tb1.metal&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Get all EC2 instances</span>
<span class="na">ec2_instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="nv">tfplan.resource_changes</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">rc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">rc.type</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">&quot;aws_instance&quot;</span><span class="w"> </span><span class="err">and</span>
<span class="w">    </span><span class="p">(</span><span class="nv">rc.change.actions</span><span class="w"> </span><span class="err">contains</span><span class="w"> </span><span class="s2">&quot;create&quot; or rc.change.actions contains &quot;update&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Get environment from tags or default to development</span>
<span class="na">get_environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">instance.change.after.tags</span><span class="w"> </span><span class="nb">else</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">tags</span><span class="p">[</span><span class="s2">&quot;Environment&quot;] else &quot;development&quot;</span>
<span class="p">}</span>

<span class="c1"># Check if instance type is allowed for environment</span>
<span class="na">instance_type_allowed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">instance_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">instance.change.after.instance_type</span>
<span class="w">    </span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">get_environment</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span>

<span class="c1">    # Always deny prohibited instances</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">instance_type</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nb">prohibited_instances</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Check environment-specific allowlist</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">environment</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="err">allowed_instances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">instance_type</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">allowed_instances</span><span class="p">[</span><span class="nb">environment</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Default to development restrictions</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">instance_type</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">allowed_instances</span><span class="p">[</span><span class="s2">&quot;development&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Main rule</span>
<span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">ec</span><span class="m">2</span><span class="err">_instances</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">instance</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">instance_type_allowed</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print violations</span>
<span class="na">print_violations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">ec</span><span class="m">2</span><span class="err">_instances</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">address</span><span class="p">,</span><span class="w"> </span><span class="nb">instance</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">instance_type_allowed</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="na">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">get_environment</span><span class="p">(</span><span class="err">instance</span><span class="p">)</span>
<span class="w">            </span><span class="err">print</span><span class="p">(</span><span class="s2">&quot;Instance&quot;, address, &quot;type&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="nv">instance.change.after.instance_type</span><span class="p">,</span>
<span class="w">                  </span><span class="s2">&quot;is not allowed for environment&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">environment</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="region-restriction-policy">Region Restriction Policy<a class="headerlink" href="#region-restriction-policy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># cost/restrict-regions.sentinel</span>
<span class="c1"># @module restrict-regions</span>
<span class="c1"># @description Restricts resources to approved AWS regions</span>
<span class="c1"># @version 1.0.0</span>
<span class="c1"># @author Tyler Dukes</span>
<span class="c1"># @last_updated 2025-01-15</span>

<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">tfplan</span>
<span class="err">import</span><span class="w"> </span><span class="s2">&quot;tfrun&quot;</span>

<span class="c1"># Approved regions</span>
<span class="na">approved_regions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;eu-central-1&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Get configured region from tfrun</span>
<span class="na">configured_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tfrun.workspace.metadata.configuration_version.provider_config.aws.config.region</span><span class="w"> </span><span class="err">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># Main rule - workspace must be in approved region</span>
<span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">configured_region</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">approved_regions</span>
<span class="p">}</span>

<span class="c1"># Print message for invalid region</span>
<span class="na">print_violation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">rule</span><span class="w"> </span><span class="err">when</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="nb">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">print</span><span class="p">(</span><span class="s2">&quot;Region&quot;, configured_region, &quot;is not in approved list:&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">approved_regions</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="sentinel-test-configuration">Sentinel Test Configuration<a class="headerlink" href="#sentinel-test-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># test/require-s3-encryption/pass.hcl</span>
<span class="c1"># Test case: S3 bucket with encryption passes</span>

<span class="err">mock</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./mock-tfplan-pass.sentinel&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nb">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># test/require-s3-encryption/fail.hcl</span>
<span class="c1"># Test case: S3 bucket without encryption fails</span>

<span class="err">mock</span><span class="w"> </span><span class="s2">&quot;tfplan/v2&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;./mock-tfplan-fail.sentinel&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nb">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># test/require-s3-encryption/mock-tfplan-pass.sentinel</span>
<span class="c1"># Mock data for passing test</span>

<span class="nb">resource_changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;aws_s3_bucket.example&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;address&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket.example&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;change&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;actions&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;create&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="s2">&quot;after&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;my-encrypted-bucket&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s2">&quot;aws_s3_bucket_server_side_encryption_configuration.example&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;address&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_server_side_encryption_configuration.example&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws_s3_bucket_server_side_encryption_configuration&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;change&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;actions&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;create&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="s2">&quot;after&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;my-encrypted-bucket&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;rule&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                    </span><span class="s2">&quot;apply_server_side_encryption_by_default&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">                        </span><span class="s2">&quot;sse_algorithm&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws:kms&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="p">}],</span>
<span class="w">                </span><span class="p">}],</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="cicd-integration">CI/CD Integration<a class="headerlink" href="#cicd-integration" title="Permanent link">&para;</a></h2>
<h3 id="github-actions-inspec-workflow">GitHub Actions InSpec Workflow<a class="headerlink" href="#github-actions-inspec-workflow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/inspec-compliance.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InSpec Compliance</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0</span><span class="nv"> </span><span class="s">6</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">compliance-scan</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout code</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Ruby</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruby/setup-ruby@v1</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ruby-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.2&#39;</span>
<span class="w">          </span><span class="nt">bundler-cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install InSpec</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">gem install inspec-bin</span>
<span class="w">          </span><span class="no">inspec version</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS credentials</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/configure-aws-credentials@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">role-to-assume</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.AWS_ROLE_ARN }}</span>
<span class="w">          </span><span class="nt">aws-region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run AWS compliance scan</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">inspec exec profiles/aws-cis-baseline \</span>
<span class="w">            </span><span class="no">--target aws:// \</span>
<span class="w">            </span><span class="no">--reporter cli json:results/aws-compliance.json \</span>
<span class="w">            </span><span class="no">--waiver-file waivers.yml</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload compliance results</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inspec-results</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check compliance status</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">python scripts/check_compliance.py results/aws-compliance.json</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fail on critical findings</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">failure()</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">echo &quot;Critical compliance findings detected&quot;</span>
<span class="w">          </span><span class="no">exit 1</span>
</code></pre></div>
<h3 id="opa-conftest-integration">OPA Conftest Integration<a class="headerlink" href="#opa-conftest-integration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/opa-validation.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPA Policy Validation</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.tf&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.yaml&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.yml&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;policies/**&#39;</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.tf&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.yaml&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;**.yml&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;policies/**&#39;</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">policy-test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout code</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup OPA</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open-policy-agent/setup-opa@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run OPA unit tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">opa test policies/ -v</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install Conftest</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.50.0/conftest_0.50.0_Linux_x86_64.tar.gz</span>
<span class="w">          </span><span class="no">tar xzf conftest_0.50.0_Linux_x86_64.tar.gz</span>
<span class="w">          </span><span class="no">sudo mv conftest /usr/local/bin/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Validate Kubernetes manifests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">conftest test kubernetes/*.yaml \</span>
<span class="w">            </span><span class="no">--policy policies/kubernetes/ \</span>
<span class="w">            </span><span class="no">--output json &gt; results/kubernetes-policy.json</span>
<span class="w">        </span><span class="nt">continue-on-error</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Validate Terraform configs</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">conftest test terraform/*.tf \</span>
<span class="w">            </span><span class="no">--policy policies/terraform/ \</span>
<span class="w">            </span><span class="no">--output json &gt; results/terraform-policy.json</span>
<span class="w">        </span><span class="nt">continue-on-error</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload policy results</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-results</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check for policy violations</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">if jq -e &#39;.[] | select(.failures | length &gt; 0)&#39; results/*.json &gt; /dev/null 2&gt;&amp;1; then</span>
<span class="w">            </span><span class="no">echo &quot;Policy violations found&quot;</span>
<span class="w">            </span><span class="no">jq &#39;.[] | select(.failures | length &gt; 0)&#39; results/*.json</span>
<span class="w">            </span><span class="no">exit 1</span>
<span class="w">          </span><span class="no">fi</span>
</code></pre></div>
<h3 id="terraform-plan-with-opa">Terraform Plan with OPA<a class="headerlink" href="#terraform-plan-with-opa" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/terraform-opa.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform with OPA</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;terraform/**&#39;</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">terraform-plan</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup Terraform</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashicorp/setup-terraform@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">terraform_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.7.0</span>
<span class="w">          </span><span class="nt">terraform_wrapper</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup OPA</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open-policy-agent/setup-opa@v2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform Init</span>
<span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform init</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Terraform Plan</span>
<span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">terraform</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">terraform plan -out=tfplan</span>
<span class="w">          </span><span class="no">terraform show -json tfplan &gt; tfplan.json</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run OPA against Terraform plan</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">opa eval \</span>
<span class="w">            </span><span class="no">--data policies/terraform/ \</span>
<span class="w">            </span><span class="no">--input terraform/tfplan.json \</span>
<span class="w">            </span><span class="no">--format pretty \</span>
<span class="w">            </span><span class="no">&quot;data.terraform.aws.s3.deny&quot; \</span>
<span class="w">            </span><span class="no">&quot;data.terraform.aws.security_groups.deny&quot;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check for violations</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">VIOLATIONS=$(opa eval \</span>
<span class="w">            </span><span class="no">--data policies/terraform/ \</span>
<span class="w">            </span><span class="no">--input terraform/tfplan.json \</span>
<span class="w">            </span><span class="no">--format json \</span>
<span class="w">            </span><span class="no">&quot;data.terraform.aws.s3.deny&quot; | jq -r &#39;.result[0].expressions[0].value | length&#39;)</span>

<span class="w">          </span><span class="no">if [ &quot;$VIOLATIONS&quot; -gt 0 ]; then</span>
<span class="w">            </span><span class="no">echo &quot;Policy violations found in Terraform plan&quot;</span>
<span class="w">            </span><span class="no">exit 1</span>
<span class="w">          </span><span class="no">fi</span>
</code></pre></div>
<h3 id="kubernetes-admission-controller">Kubernetes Admission Controller<a class="headerlink" href="#kubernetes-admission-controller" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># kubernetes/opa-gatekeeper.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates.gatekeeper.sh/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConstraintTemplate</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8srequiredlabels</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">crd</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">names</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8sRequiredLabels</span>
<span class="w">      </span><span class="nt">validation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">openAPIV3Schema</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">          </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
<span class="w">              </span><span class="nt">items</span><span class="p">:</span>
<span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admission.k8s.gatekeeper.sh</span>
<span class="w">      </span><span class="nt">rego</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">package k8srequiredlabels</span>

<span class="w">        </span><span class="no">import rego.v1</span>

<span class="w">        </span><span class="no">violation contains {&quot;msg&quot;: msg, &quot;details&quot;: {&quot;missing_labels&quot;: missing}} if {</span>
<span class="w">          </span><span class="no">provided := {label | input.review.object.metadata.labels[label]}</span>
<span class="w">          </span><span class="no">required := {label | label := input.parameters.labels[_]}</span>
<span class="w">          </span><span class="no">missing := required - provided</span>
<span class="w">          </span><span class="no">count(missing) &gt; 0</span>
<span class="w">          </span><span class="no">msg := sprintf(&quot;Missing required labels: %v&quot;, [missing])</span>
<span class="w">        </span><span class="no">}</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">constraints.gatekeeper.sh/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8sRequiredLabels</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require-team-label</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">match</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kinds</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">kinds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;Namespace&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;apps&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">kinds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;Deployment&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;team&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;environment&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;app&quot;</span>
</code></pre></div>
<hr />
<h2 id="compliance-framework-mapping">Compliance Framework Mapping<a class="headerlink" href="#compliance-framework-mapping" title="Permanent link">&para;</a></h2>
<h3 id="cis-benchmark-mapping">CIS Benchmark Mapping<a class="headerlink" href="#cis-benchmark-mapping" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># profiles/cis-aws-foundations/controls/iam.rb</span>
<span class="c1"># CIS AWS Foundations Benchmark - IAM Controls</span>

<span class="c1"># CIS 1.1 - Avoid the use of root account</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.1&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Avoid the use of root account&#39;</span>
<span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s1">&#39;The root account has unrestricted access. Avoid using it for daily tasks.&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.4.0&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.1&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">nist</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;AC-2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AC-6&#39;</span><span class="o">]</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;7.1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;7.2&#39;</span><span class="o">]</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;164.312(a)(1)&#39;</span><span class="o">]</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">soc2</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;CC6.1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CC6.2&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_root_user</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">have_mfa_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">have_access_key</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.4 - Ensure access keys are rotated every 90 days or less</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.4&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure access keys are rotated every 90 days or less&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.4.0&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.4&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">nist</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;AC-2&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="n">aws_iam_access_keys</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">key</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Access key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">access_key_id</span><span class="si">}</span><span class="s2"> for user </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">subject</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;created_days_ago&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.5 - Ensure IAM password policy requires at least one uppercase letter</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.5&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires uppercase&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.5&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;require_uppercase_characters&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.6 - Ensure IAM password policy requires at least one lowercase letter</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.6&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires lowercase&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.6&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;require_lowercase_characters&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.7 - Ensure IAM password policy requires at least one symbol</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.7&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires symbols&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.7&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;require_symbols&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.8 - Ensure IAM password policy requires at least one number</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.8&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires numbers&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.8&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;require_numbers&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.9 - Ensure IAM password policy requires minimum length of 14 or greater</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.9&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy requires minimum length of 14&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.9&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;minimum_password_length&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># CIS 1.10 - Ensure IAM password policy prevents password reuse</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;cis-aws-1.10&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Ensure IAM password policy prevents password reuse&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_benchmark</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;CIS AWS Foundations&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_control</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.10&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_level</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">aws_iam_password_policy</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;password_reuse_prevention&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="pci-dss-mapping">PCI-DSS Mapping<a class="headerlink" href="#pci-dss-mapping" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># profiles/pci-dss/controls/requirement_2.rb</span>
<span class="c1"># PCI-DSS Requirement 2: Do not use vendor-supplied defaults</span>

<span class="c1"># Requirement 2.1 - Change vendor-supplied defaults</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;pci-dss-2.1&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Change vendor-supplied defaults before system installation&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Requirement 2.1&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss_version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.2.1&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">cis_controls</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;5.1&#39;</span><span class="o">]</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">nist</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;CM-6&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CM-7&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="c1"># SSH should not use default port</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_listening</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># Check for non-default SSH port</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Port&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Requirement 2.2 - Configuration standards</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;pci-dss-2.2&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Develop configuration standards for all system components&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Requirement 2.2&#39;</span>

<span class="w">  </span><span class="c1"># Primary function only</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;telnet&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;rsh-server&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Requirement 2.2.2 - Enable only necessary services</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;pci-dss-2.2.2&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Enable only necessary services, protocols, daemons&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Requirement 2.2.2&#39;</span>

<span class="w">  </span><span class="n">unnecessary_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sx">%w[</span>
<span class="sx">    cups</span>
<span class="sx">    avahi-daemon</span>
<span class="sx">    nfs</span>
<span class="sx">    rpcbind</span>
<span class="sx">    bluetooth</span>
<span class="sx">  ]</span>

<span class="w">  </span><span class="n">unnecessary_services</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">svc</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="n">svc</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_running</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Requirement 2.2.4 - Configure security parameters</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;pci-dss-2.2.4&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Configure system security parameters&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Requirement 2.2.4&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">kernel_parameter</span><span class="p">(</span><span class="s1">&#39;net.ipv4.ip_forward&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">kernel_parameter</span><span class="p">(</span><span class="s1">&#39;net.ipv4.conf.all.accept_redirects&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">kernel_parameter</span><span class="p">(</span><span class="s1">&#39;net.ipv4.conf.all.send_redirects&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Requirement 2.3 - Encrypt non-console admin access</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;pci-dss-2.3&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Encrypt all non-console administrative access&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">pci_dss</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Requirement 2.3&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Protocol&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;Ciphers&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="sr">/3des|arcfour|blowfish/</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="hipaa-mapping">HIPAA Mapping<a class="headerlink" href="#hipaa-mapping" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># profiles/hipaa/controls/access_controls.rb</span>
<span class="c1"># HIPAA Security Rule - Access Controls</span>

<span class="c1"># 164.312(a)(1) - Access Control</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(a)(1)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Implement access controls for ePHI systems&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(a)(1)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_section</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Technical Safeguards&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Access Control&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">nist</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;AC-2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;AC-3&#39;</span><span class="o">]</span>

<span class="w">  </span><span class="c1"># Unique user identification</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">passwd</span><span class="o">.</span><span class="n">where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;entries.length&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># No shared accounts</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">shadow</span><span class="o">.</span><span class="n">where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;!&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;shared&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="s1">&#39;generic&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(a)(2)(i) - Unique User Identification</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(a)(2)(i)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Assign unique user identification&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(a)(2)(i)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Unique User Identification&#39;</span>

<span class="w">  </span><span class="c1"># All users should have unique UIDs</span>
<span class="w">  </span><span class="n">user_uids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="n">passwd</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">user</span><span class="o">|</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">user_uids</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
<span class="w">      </span><span class="n">describe</span><span class="w"> </span><span class="s2">&quot;User </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2"> UID </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="n">user_uids</span><span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="o">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">user_uids</span><span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">user</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(a)(2)(iii) - Automatic Logoff</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(a)(2)(iii)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Implement automatic logoff&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(a)(2)(iii)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Automatic Logoff&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;ClientAliveInterval&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;ClientAliveCountMax&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/profile.d/tmout.sh&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="sr">/TMOUT=\d+/</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(a)(2)(iv) - Encryption and Decryption</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(a)(2)(iv)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Implement encryption mechanism for ePHI&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(a)(2)(iv)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Encryption and Decryption&#39;</span>

<span class="w">  </span><span class="c1"># Disk encryption</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;lsblk -o NAME,FSTYPE,MOUNTPOINT | grep crypt&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should_not</span><span class="w"> </span><span class="n">be_empty</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1"># TLS for network communications</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">ssl_certificate</span><span class="p">(</span><span class="ss">host</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">443</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="sr">/TLSv1\.[23]/</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(b) - Audit Controls</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(b)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Implement audit controls for ePHI access&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(b)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_section</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Technical Safeguards&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Audit Controls&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="s1">&#39;auditd&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_enabled</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_running</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">auditd_conf</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;space_left_action&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;SYSLOG&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;admin_space_left_action&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;SUSPEND&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;disk_full_action&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;SUSPEND&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(c)(1) - Integrity Controls</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(c)(1)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Implement integrity controls for ePHI&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(c)(1)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Integrity&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">package</span><span class="p">(</span><span class="s1">&#39;aide&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_installed</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/aide.conf&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">exist</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 164.312(d) - Person or Entity Authentication</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;hipaa-164.312(d)&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">impact</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="s1">&#39;Verify person or entity seeking access to ePHI&#39;</span>

<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;164.312(d)&#39;</span>
<span class="w">  </span><span class="n">tag</span><span class="w"> </span><span class="ss">hipaa_standard</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Authentication&#39;</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;PubkeyAuthentication&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;yes&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;PasswordAuthentication&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="s1">&#39;no&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">pam</span><span class="p">(</span><span class="s1">&#39;/etc/pam.d/common-auth&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">its</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="kp">include</span><span class="p">(</span><span class="sr">/pam_faillock/</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<hr />
<h2 id="reporting-and-dashboards">Reporting and Dashboards<a class="headerlink" href="#reporting-and-dashboards" title="Permanent link">&para;</a></h2>
<h3 id="inspec-json-reporter">InSpec JSON Reporter<a class="headerlink" href="#inspec-json-reporter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># scripts/compliance_report.rb</span>
<span class="c1"># Generate compliance report from InSpec JSON output</span>

<span class="nb">require</span><span class="w"> </span><span class="s1">&#39;json&#39;</span>
<span class="nb">require</span><span class="w"> </span><span class="s1">&#39;erb&#39;</span>
<span class="nb">require</span><span class="w"> </span><span class="s1">&#39;time&#39;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ComplianceReport</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
<span class="w">    </span><span class="vi">@results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_results</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">parse_results</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="ss">passed</span><span class="p">:</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span>
<span class="w">      </span><span class="ss">failed</span><span class="p">:</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span>
<span class="w">      </span><span class="ss">skipped</span><span class="p">:</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span>
<span class="w">      </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">summary</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="ss">total</span><span class="p">:</span><span class="w"> </span><span class="vi">@data</span><span class="o">[</span><span class="s1">&#39;controls&#39;</span><span class="o">].</span><span class="n">length</span><span class="p">,</span>
<span class="w">      </span><span class="ss">passed</span><span class="p">:</span><span class="w"> </span><span class="n">count_by_status</span><span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="ss">failed</span><span class="p">:</span><span class="w"> </span><span class="n">count_by_status</span><span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="ss">skipped</span><span class="p">:</span><span class="w"> </span><span class="n">count_by_status</span><span class="p">(</span><span class="s1">&#39;skipped&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="ss">score</span><span class="p">:</span><span class="w"> </span><span class="n">calculate_score</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">count_by_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@data</span><span class="o">[</span><span class="s1">&#39;controls&#39;</span><span class="o">].</span><span class="n">count</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="o">[</span><span class="s1">&#39;results&#39;</span><span class="o">].</span><span class="n">all?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">[</span><span class="s1">&#39;status&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_score</span>
<span class="w">    </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count_by_status</span><span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@data</span><span class="o">[</span><span class="s1">&#39;controls&#39;</span><span class="o">].</span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">count_by_status</span><span class="p">(</span><span class="s1">&#39;skipped&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total</span><span class="o">.</span><span class="n">zero?</span>
<span class="w">    </span><span class="p">((</span><span class="n">passed</span><span class="o">.</span><span class="n">to_f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">by_severity</span>
<span class="w">    </span><span class="n">severity_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;high&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;medium&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[]</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;low&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="vi">@data</span><span class="o">[</span><span class="s1">&#39;controls&#39;</span><span class="o">].</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">control</span><span class="o">|</span>
<span class="w">      </span><span class="n">impact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">control</span><span class="o">[</span><span class="s1">&#39;impact&#39;</span><span class="o">]</span>
<span class="w">      </span><span class="n">severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">impact</span>
<span class="w">                 </span><span class="k">when</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">9</span><span class="o">..</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span>
<span class="w">                 </span><span class="k">when</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="o">...</span><span class="mi">0</span><span class="o">.</span><span class="mi">9</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;high&#39;</span>
<span class="w">                 </span><span class="k">when</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="o">...</span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;medium&#39;</span>
<span class="w">                 </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;low&#39;</span>
<span class="w">                 </span><span class="k">end</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">control</span><span class="o">[</span><span class="s1">&#39;results&#39;</span><span class="o">].</span><span class="n">any?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="o">[</span><span class="s1">&#39;status&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="n">severity_map</span><span class="o">[</span><span class="n">severity</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">control</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">severity_map</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">to_html</span>
<span class="w">    </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;templates/report.html.erb&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="n">template</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">to_markdown</span>
<span class="w">    </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;templates/report.md.erb&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="n">template</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage</span>
<span class="k">if</span><span class="w"> </span><span class="bp">__FILE__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="vg">$PROGRAM_NAME</span>
<span class="w">  </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ComplianceReport</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">puts</span><span class="w"> </span><span class="n">report</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="compliance-dashboard-yaml">Compliance Dashboard YAML<a class="headerlink" href="#compliance-dashboard-yaml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># monitoring/grafana/dashboards/compliance.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">providers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Compliance Dashboards</span>
<span class="w">    </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Compliance</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file</span>
<span class="w">    </span><span class="nt">options</span><span class="p">:</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/grafana/dashboards/compliance</span>

<span class="c1"># Dashboard JSON</span>
<span class="nn">---</span>
<span class="p p-Indicator">{</span>
<span class="w">  </span><span class="s">&quot;dashboard&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Compliance</span><span class="nv"> </span><span class="s">Overview&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;tags&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;compliance&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;security&quot;</span><span class="p p-Indicator">],</span>
<span class="w">    </span><span class="s">&quot;panels&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Overall</span><span class="nv"> </span><span class="s">Compliance</span><span class="nv"> </span><span class="s">Score&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;stat&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;gridPos&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">4</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;targets&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;expr&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;compliance_score_percentage&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;legendFormat&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Score&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">],</span>
<span class="w">        </span><span class="s">&quot;fieldConfig&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">          </span><span class="s">&quot;defaults&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;thresholds&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">              </span><span class="s">&quot;steps&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">                </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">                </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">70</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;yellow&quot;</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">                </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">90</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">              </span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="p p-Indicator">},</span>
<span class="w">            </span><span class="s">&quot;unit&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;percent&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">}</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Controls</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Status&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;piechart&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;gridPos&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;targets&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;expr&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sum(compliance_controls_total)</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">(status)&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;legendFormat&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;{{status}}&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">Controls</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Severity&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;bargauge&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;gridPos&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;targets&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;expr&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sum(compliance_controls_failed)</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">(severity)&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;legendFormat&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;{{severity}}&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Compliance</span><span class="nv"> </span><span class="s">Trend&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;timeseries&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;gridPos&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;targets&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;expr&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;compliance_score_percentage&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;legendFormat&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Compliance</span><span class="nv"> </span><span class="s">Score&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;title&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Framework</span><span class="nv"> </span><span class="s">Coverage&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;table&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;gridPos&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">8</span><span class="w"> </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;targets&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;expr&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;compliance_framework_coverage&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;format&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;table&quot;</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">],</span>
<span class="w">        </span><span class="s">&quot;transformations&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;organize&quot;</span><span class="p p-Indicator">,</span>
<span class="w">            </span><span class="s">&quot;options&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">              </span><span class="s">&quot;indexByName&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">                </span><span class="s">&quot;framework&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">0</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;passed&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;failed&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;total&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span>
<span class="w">                </span><span class="s">&quot;coverage&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="nv">4</span>
<span class="w">              </span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="p p-Indicator">}</span>
<span class="w">          </span><span class="p p-Indicator">}</span>
<span class="w">        </span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
<h3 id="prometheus-metrics-exporter">Prometheus Metrics Exporter<a class="headerlink" href="#prometheus-metrics-exporter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># scripts/compliance_metrics_exporter.py</span>
<span class="c1"># Export InSpec results to Prometheus metrics</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@module compliance_metrics_exporter</span>
<span class="sd">@description Export compliance scan results to Prometheus</span>
<span class="sd">@version 1.0.0</span>
<span class="sd">@author Tyler Dukes</span>
<span class="sd">@last_updated 2025-01-15</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">start_http_server</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Define metrics</span>
<span class="n">COMPLIANCE_SCORE</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_score_percentage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Overall compliance score as percentage&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">CONTROLS_TOTAL</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_controls_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total number of controls&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">CONTROLS_BY_SEVERITY</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_controls_by_severity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Controls grouped by severity&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">FRAMEWORK_COVERAGE</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_framework_coverage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Coverage by compliance framework&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;framework&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">SCAN_DURATION</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_scan_duration_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Duration of compliance scan&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">LAST_SCAN_TIMESTAMP</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;compliance_last_scan_timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Timestamp of last compliance scan&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_inspec_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse InSpec JSON output file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculate_severity</span><span class="p">(</span><span class="n">impact</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate severity level from impact score.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">impact</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;critical&#39;</span>
    <span class="k">elif</span> <span class="n">impact</span> <span class="o">&gt;=</span> <span class="mf">0.7</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
    <span class="k">elif</span> <span class="n">impact</span> <span class="o">&gt;=</span> <span class="mf">0.4</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;low&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_framework_tags</span><span class="p">(</span><span class="n">control</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract compliance framework tags from control.&quot;&quot;&quot;</span>
    <span class="n">frameworks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">framework_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cis_benchmark&#39;</span><span class="p">,</span> <span class="s1">&#39;pci_dss&#39;</span><span class="p">,</span> <span class="s1">&#39;hipaa&#39;</span><span class="p">,</span> <span class="s1">&#39;soc2&#39;</span><span class="p">,</span> <span class="s1">&#39;nist&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">framework_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">frameworks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">frameworks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update Prometheus metrics from InSpec data.&quot;&quot;&quot;</span>
    <span class="n">profile_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>

    <span class="n">controls</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">status_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;skipped&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">severity_counts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="n">framework_counts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">controls</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">severity</span> <span class="o">=</span> <span class="n">calculate_severity</span><span class="p">(</span><span class="n">impact</span><span class="p">)</span>

        <span class="c1"># Determine overall status for this control</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;passed&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;passed&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;skipped&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;skipped&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>

        <span class="n">status_counts</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">severity_counts</span><span class="p">[</span><span class="n">severity</span><span class="p">][</span><span class="n">status</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Track framework coverage</span>
        <span class="n">frameworks</span> <span class="o">=</span> <span class="n">extract_framework_tags</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">framework</span> <span class="ow">in</span> <span class="n">frameworks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">framework</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">framework_counts</span><span class="p">:</span>
                <span class="n">framework_counts</span><span class="p">[</span><span class="n">framework</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="n">framework_counts</span><span class="p">[</span><span class="n">framework</span><span class="p">][</span><span class="n">status</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Update status metrics</span>
    <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">status_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">CONTROLS_TOTAL</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="c1"># Update severity metrics</span>
    <span class="k">for</span> <span class="n">severity</span><span class="p">,</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">severity_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">CONTROLS_BY_SEVERITY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
                <span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span>
            <span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="c1"># Calculate and update compliance score</span>
    <span class="n">total_applicable</span> <span class="o">=</span> <span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">total_applicable</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_applicable</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">COMPLIANCE_SCORE</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># Update framework coverage</span>
    <span class="k">for</span> <span class="n">framework</span><span class="p">,</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">framework_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">FRAMEWORK_COVERAGE</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">coverage</span><span class="p">)</span>

    <span class="c1"># Update scan metadata</span>
    <span class="n">LAST_SCAN_TIMESTAMP</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;statistics&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">SCAN_DURATION</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usage: compliance_metrics_exporter.py &lt;inspec_json_file&gt; [port]&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">json_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">9100</span>

    <span class="c1"># Start Prometheus HTTP server</span>
    <span class="n">start_http_server</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving metrics on port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initial load</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_inspec_json</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
    <span class="n">update_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Keep running and allow for file updates</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">parse_inspec_json</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="n">update_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="recommended-tools">Recommended Tools<a class="headerlink" href="#recommended-tools" title="Permanent link">&para;</a></h2>
<h3 id="inspec-tools">InSpec Tools<a class="headerlink" href="#inspec-tools" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>InSpec CLI</strong>: Core compliance testing tool</li>
<li>Installation: <code>gem install inspec-bin</code></li>
<li>
<p>Run: <code>inspec exec profile_path --target ssh://user@host</code></p>
</li>
<li>
<p><strong>InSpec Automate</strong>: Enterprise compliance dashboard</p>
</li>
<li>Installation: Chef Automate deployment</li>
<li>
<p>Integration: <code>inspec exec . --reporter automate</code></p>
</li>
<li>
<p><strong>Kitchen-InSpec</strong>: Test Kitchen integration</p>
</li>
<li>Installation: <code>gem install kitchen-inspec</code></li>
<li>Configuration: <code>.kitchen.yml</code> with InSpec verifier</li>
</ul>
<h3 id="opa-tools">OPA Tools<a class="headerlink" href="#opa-tools" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>OPA CLI</strong>: Policy engine and testing</li>
<li>Installation: <code>brew install opa</code> or binary download</li>
<li>
<p>Run: <code>opa eval --data policies/ --input input.json "data.policy.deny"</code></p>
</li>
<li>
<p><strong>Conftest</strong>: Configuration file testing</p>
</li>
<li>Installation: <code>brew install conftest</code></li>
<li>
<p>Run: <code>conftest test --policy policies/ config.yaml</code></p>
</li>
<li>
<p><strong>Gatekeeper</strong>: Kubernetes admission controller</p>
</li>
<li>Installation: <code>kubectl apply -f gatekeeper.yaml</code></li>
<li>Integration: Native Kubernetes admission webhooks</li>
</ul>
<h3 id="sentinel-tools">Sentinel Tools<a class="headerlink" href="#sentinel-tools" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Sentinel CLI</strong>: Policy testing</li>
<li>Installation: Download from HashiCorp</li>
<li>
<p>Run: <code>sentinel test</code></p>
</li>
<li>
<p><strong>Terraform Cloud</strong>: Sentinel integration</p>
</li>
<li>Configuration: Policy sets in TFC organization</li>
<li>Integration: Automatic policy checks on runs</li>
</ul>
<h3 id="ide-extensions">IDE Extensions<a class="headerlink" href="#ide-extensions" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>VS Code InSpec Extension</strong>: Syntax highlighting and snippets</li>
<li><strong>VS Code OPA Extension</strong>: Rego syntax and evaluation</li>
<li><strong>VS Code Sentinel Extension</strong>: Sentinel syntax highlighting</li>
</ul>
<h3 id="pre-commit-configuration">Pre-commit Configuration<a class="headerlink" href="#pre-commit-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># .pre-commit-config.yaml</span>
<span class="nt">repos</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/open-policy-agent/conftest</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.50.0</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conftest-verify</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;--policy&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;policies/&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.(yaml|yml|json|tf)$</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa-fmt</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPA Format</span>
<span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa fmt -w</span>
<span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.rego$</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa-check</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPA Check</span>
<span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa check</span>
<span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\.rego$</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;policies/&#39;</span><span class="p p-Indicator">]</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inspec-check</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InSpec Check</span>
<span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inspec check</span>
<span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(controls/.*\.rb|inspec\.yml)$</span>
<span class="w">        </span><span class="nt">pass_filenames</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;profiles/&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<hr />
<h2 id="anti-patterns-to-avoid">Anti-Patterns to Avoid<a class="headerlink" href="#anti-patterns-to-avoid" title="Permanent link">&para;</a></h2>
<h3 id="overly-permissive-policies">Overly Permissive Policies<a class="headerlink" href="#overly-permissive-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Bad - policy that allows everything</span>
<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span>

<span class="c1"># This policy never denies anything</span>
<span class="n">deny</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">false</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;This will never trigger&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Good - explicit allow with default deny</span>
<span class="k">package</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">admission</span>

<span class="k">import</span><span class="w"> </span><span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="k">default</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">false</span>

<span class="n">allow</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="n">image</span>
<span class="w">    </span><span class="n">startswith</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;approved-registry.com/&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">allow</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Request denied by default policy&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="hardcoded-values">Hardcoded Values<a class="headerlink" href="#hardcoded-values" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Bad - hardcoded IP addresses and values</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="n">host</span><span class="p">(</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_reachable</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Good - use attributes for configurable values</span>
<span class="n">control</span><span class="w"> </span><span class="s1">&#39;network-01&#39;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">allowed_hosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attribute</span><span class="p">(</span><span class="s1">&#39;allowed_hosts&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="o">[]</span><span class="p">)</span>

<span class="w">  </span><span class="n">allowed_hosts</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">host_ip</span><span class="o">|</span>
<span class="w">    </span><span class="n">describe</span><span class="w"> </span><span class="n">host</span><span class="p">(</span><span class="n">host_ip</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be_reachable</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="missing-error-context">Missing Error Context<a class="headerlink" href="#missing-error-context" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Bad - vague error message</span>
<span class="n">deny</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">valid_image</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&quot;Invalid image&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Good - detailed error message with context</span>
<span class="n">deny</span><span class="w"> </span><span class="k">contains</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="k">some</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nb">input</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="w">    </span><span class="n">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">image</span>
<span class="w">    </span><span class="k">not</span><span class="w"> </span><span class="n">image_from_approved_registry</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span>
<span class="w">        </span><span class="s2">&quot;Container &#39;%s&#39; uses image &#39;%s&#39; which is not from an approved registry. Approved registries: %v&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">approved_registries</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="untestable-policies">Untestable Policies<a class="headerlink" href="#untestable-policies" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Bad - policy with no clear test cases</span>
<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;check-something&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="c1">    # Complex nested logic that&#39;s hard to test</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">resources</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">r</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="err">some_complex_condition</span><span class="p">(</span><span class="err">r</span><span class="p">)</span><span class="w"> </span><span class="err">or</span>
<span class="w">      </span><span class="err">another_condition</span><span class="p">(</span><span class="err">r</span><span class="p">)</span><span class="w"> </span><span class="err">or</span>
<span class="w">      </span><span class="err">yet_another_condition</span><span class="p">(</span><span class="err">r</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Good - modular, testable policy</span>
<span class="err">policy</span><span class="w"> </span><span class="s2">&quot;check-encryption&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="c1">  # Single responsibility - check encryption only</span>
<span class="w">  </span><span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">all</span><span class="w"> </span><span class="err">s</span><span class="m">3</span><span class="err">_buckets</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="nb">bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="err">bucket_has_encryption</span><span class="p">(</span><span class="err">bucket</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Separate helper that can be tested independently</span>
<span class="na">bucket_has_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">func</span><span class="p">(</span><span class="err">bucket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">return</span><span class="w"> </span><span class="nv">bucket.change.after.server_side_encryption_configuration</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="kt">null</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<h3 id="official-documentation">Official Documentation<a class="headerlink" href="#official-documentation" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.chef.io/inspec/">InSpec Documentation</a></li>
<li><a href="https://www.openpolicyagent.org/docs/">Open Policy Agent Documentation</a></li>
<li><a href="https://developer.hashicorp.com/sentinel/docs">Terraform Sentinel Documentation</a></li>
<li><a href="https://www.conftest.dev/">Conftest Documentation</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/">Gatekeeper Documentation</a></li>
</ul>
<h3 id="compliance-frameworks">Compliance Frameworks<a class="headerlink" href="#compliance-frameworks" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.cisecurity.org/cis-benchmarks/">CIS Benchmarks</a></li>
<li><a href="https://www.pcisecuritystandards.org/">PCI DSS Standards</a></li>
<li><a href="https://www.hhs.gov/hipaa/for-professionals/security/">HIPAA Security Rule</a></li>
<li><a href="https://www.nist.gov/cyberframework">NIST Cybersecurity Framework</a></li>
<li><a href="https://www.aicpa.org/soc">SOC 2 Compliance</a></li>
</ul>
<h3 id="community-resources">Community Resources<a class="headerlink" href="#community-resources" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://dev-sec.io/">DevSec Hardening Framework</a></li>
<li><a href="https://github.com/inspec/inspec-aws">InSpec AWS Resource Pack</a></li>
<li><a href="https://play.openpolicyagent.org/">OPA Playground</a></li>
<li><a href="https://github.com/StyraInc/rego-style-guide">Rego Style Guide</a></li>
</ul>
<h3 id="related-guides">Related Guides<a class="headerlink" href="#related-guides" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="../terraform/">Terraform Style Guide</a></li>
<li><a href="../kubernetes/">Kubernetes Style Guide</a></li>
<li><a href="../github_actions/">GitHub Actions Style Guide</a></li>
<li><a href="../../05_ci_cd/security_scanning_guide/">Security Scanning Guide</a></li>
</ul>
<hr />
<p><strong>Maintainer</strong>: Tyler Dukes</p>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/tydukes" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/tydukes" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "content.code.annotate", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>